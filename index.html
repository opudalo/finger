<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Permissions-Policy" content="screen-wake-lock=()" />
    <title>Finger Training Timer</title>
    <style>
      :root {
        --vh: 1vh; /* Fallback for browsers that don't support dvh */
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: monospace;
        background: #000;
        color: #fff;
        min-height: 100vh;
        min-height: calc(
          var(--vh, 1vh) * 100
        ); /* Fallback for older browsers */
        min-height: 100dvh; /* Dynamic viewport height for mobile */
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        height: calc(var(--vh, 1vh) * 100); /* Fallback for older browsers */
        height: 100dvh; /* Dynamic viewport height for mobile */
        width: 100vw;
        width: 100dvw; /* Dynamic viewport width for mobile */
        padding: 0;
        margin: 0;
      }

      .container {
        text-align: center;
        background: #000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        height: 100vh;
        height: calc(var(--vh, 1vh) * 100); /* Fallback for older browsers */
        height: 100dvh; /* Dynamic viewport height for mobile */
        border: 4px solid #ffff00;
        padding: 20px;
      }

      .exercise-info {
        padding: 20px 0;
        font-size: min(10vh, 10vw);
      }

      .exercise-name {
        color: #ffff00;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .exercise-details {
        color: #fff;
      }

      .timer-display {
        text-align: center;
        margin: 10px 0;
      }

      .timer-value {
        font-size: min(30vh, 60vw);
        color: #ffff00;
        font-variant-numeric: tabular-nums;
        line-height: 1;
        font-family: monospace;
      }

      button {
        padding: 32px 30px;
        font-size: min(10vh, 15vw);
        width: 100%;
        flex: 1;
        border: 1px solid #ffff00;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 2px;
        background: #000;
        color: #ffff00;
        font-family: monospace;
      }

      button:hover {
        background: #ffff00;
        color: #000;
      }

      .btn-primary {
        background: #ffff00;
        color: #000;
      }

      .btn-primary:hover {
        background: #fff;
      }

      .controls {
        display: flex;
        justify-content: stretch;
        gap: 10px;
        width: 100%;
        margin-top: 30px;
      }

      /* Fullscreen styles */
      :fullscreen {
        background: #000;
      }

      :-webkit-full-screen {
        background: #000;
      }

      :-moz-full-screen {
        background: #000;
      }

      :-ms-fullscreen {
        background: #000;
      }

      /* Ensure the container takes full space in fullscreen */
      :fullscreen .container,
      :-webkit-full-screen .container,
      :-moz-full-screen .container,
      :-ms-fullscreen .container {
        height: 100vh;
        height: calc(var(--vh, 1vh) * 100); /* Fallback for older browsers */
        height: 100dvh; /* Dynamic viewport height for mobile */
        width: 100vw;
        width: 100dvw; /* Dynamic viewport width for mobile */
        border: none;
        padding: 20px;
      }

      /* Version label */
      .version-label {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 0, 0.8);
        color: #000;
        padding: 4px 8px;
        font-size: 12px;
        font-family: monospace;
        border-radius: 4px;
        z-index: 1000;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <!-- Version label -->
    <div class="version-label" id="versionLabel">v1.0.2</div>

    <div class="container">
      <div class="exercise-info">
        <div class="exercise-name" id="exerciseName">READY</div>
        <div class="exercise-details" id="exerciseDetails">&nbsp;</div>
      </div>

      <div class="timer-display">
        <div class="timer-value" id="timerValue">0</div>
      </div>

      <div class="controls">
        <button class="btn-primary" id="startBtn" onclick="startTimer()">
          START
        </button>
        <button id="pauseBtn" onclick="pauseTimer()" style="display: none">
          PAUSE
        </button>
      </div>
    </div>

    <script>
      const exercises = [
        { name: 'Half Crimp', sets: 6, workTime: 10, restTime: 15 },
        { name: '3 Finger Drag', sets: 6, workTime: 10, restTime: 15 },
        { name: 'Front 2 Finger Drag', sets: 2, workTime: 10, restTime: 15 },
        { name: 'Middle 2 Finger Drag', sets: 2, workTime: 10, restTime: 15 },
        {
          name: 'Front 2 Finger Half Crimp',
          sets: 2,
          workTime: 10,
          restTime: 15
        },
        {
          name: 'Middle 2 Finger Half Crimp',
          sets: 2,
          workTime: 10,
          restTime: 15
        }
      ];

      let currentExerciseIndex = 0;
      let currentSet = 0;
      let currentTime = 0;
      let isWorking = true;
      let isPaused = false;
      let timerInterval = null;
      let wakeLock = null;

      const audioContext = new (window.AudioContext ||
        window.webkitAudioContext)();

      async function requestWakeLock() {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          console.log('Wake lock acquired');

          // Handle wake lock release - using both methods like MDN demo
          wakeLock.onrelease = function (ev) {
            console.log('Wake lock released:', ev);
          };

          wakeLock.addEventListener('release', () => {
            console.log('Wake lock released via event listener');
          });
        } catch (err) {
          console.log('Wake lock failed:', err.name, err.message);
        }
      }

      function releaseWakeLock() {
        if (wakeLock) {
          wakeLock.release().then(() => {
            wakeLock = null;
            console.log('Wake lock released');
          });
        }
      }

      function playBeep(frequency = 1200, duration = 0.3) {
        try {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.frequency.value = frequency;
          oscillator.type = 'sine';

          gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            audioContext.currentTime + duration
          );

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + duration);
        } catch (e) {
          console.log('Audio playback failed:', e);
        }
      }

      function updateDisplay() {
        const exercise = exercises[currentExerciseIndex];
        const totalTime = isWorking ? exercise.workTime : exercise.restTime;
        const timeLeft = totalTime - currentTime;

        document.getElementById('timerValue').textContent = timeLeft;

        if (isWorking) {
          document.getElementById('exerciseName').textContent =
            exercise.name.toUpperCase();
          document.getElementById('exerciseDetails').textContent = `Set ${
            currentSet + 1
          } of ${exercise.sets}`;
        } else {
          document.getElementById('exerciseName').textContent = 'REST';
          document.getElementById('exerciseDetails').textContent = `${
            currentSet < exercise.sets - 1
              ? exercise.name
              : currentExerciseIndex < exercises.length - 1
              ? exercises[currentExerciseIndex + 1].name
              : 'Complete!'
          }`;
        }
      }

      function tick() {
        if (isPaused) return;

        const exercise = exercises[currentExerciseIndex];
        const totalTime = isWorking ? exercise.workTime : exercise.restTime;

        currentTime++;

        if (currentTime >= totalTime) {
          playBeep(1200, 0.3);

          currentTime = 0;

          if (isWorking) {
            isWorking = false;

            if (currentSet >= exercise.sets - 1) {
              currentSet = 0;
              currentExerciseIndex++;

              if (currentExerciseIndex >= exercises.length) {
                completeTraining();
                return;
              }
            } else {
              currentSet++;
            }
          } else {
            isWorking = true;
          }
        }

        updateDisplay();
      }

      async function startTimer() {
        if (timerInterval) return;

        isPaused = false;
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('pauseBtn').style.display = 'inline-block';

        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }

        // Request wake lock immediately - like MDN demo
        await requestWakeLock();

        // Request fullscreen
        try {
          if (document.documentElement.requestFullscreen) {
            await document.documentElement.requestFullscreen();
          } else if (document.documentElement.webkitRequestFullscreen) {
            await document.documentElement.webkitRequestFullscreen();
          } else if (document.documentElement.msRequestFullscreen) {
            await document.documentElement.msRequestFullscreen();
          }
        } catch (err) {
          console.log('Fullscreen request failed:', err);
        }

        // Start 5-second countdown
        let countdown = 5;
        document.getElementById('exerciseName').textContent = 'GET READY';
        document.getElementById('exerciseDetails').textContent =
          'Starting in...';
        document.getElementById('timerValue').textContent = countdown;

        const countdownInterval = setInterval(() => {
          countdown--;
          document.getElementById('timerValue').textContent = countdown;

          if (countdown <= 0) {
            clearInterval(countdownInterval);
            // Start the actual timer
            updateDisplay();
            timerInterval = setInterval(tick, 1000);
          }
        }, 1000);
      }

      function pauseTimer() {
        isPaused = !isPaused;
        document.getElementById('pauseBtn').textContent = isPaused
          ? 'RESUME'
          : 'PAUSE';
      }

      function completeTraining() {
        clearInterval(timerInterval);
        timerInterval = null;

        // Release wake lock when training is complete
        releaseWakeLock();

        // Exit fullscreen
        try {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        } catch (err) {
          console.log('Exit fullscreen failed:', err);
        }

        document.getElementById('exerciseName').textContent = 'COMPLETE!';
        document.getElementById('exerciseDetails').textContent =
          'Great job! All exercises finished.';
        document.getElementById('timerValue').textContent = '✓';

        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('pauseBtn').style.display = 'none';

        playBeep(1000, 0.2);
        setTimeout(() => playBeep(1200, 0.2), 200);
        setTimeout(() => playBeep(1500, 0.3), 400);
      }

      // Mobile viewport height fix for older browsers
      function setMobileViewportHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      }

      // Set viewport height on load and resize
      setMobileViewportHeight();
      window.addEventListener('resize', setMobileViewportHeight);
      window.addEventListener('orientationchange', () => {
        setTimeout(setMobileViewportHeight, 100);
      });

      // Handle visibility changes - exactly like MDN demo
      const handleVisibilityChange = () => {
        if (wakeLock !== null && document.visibilityState === 'visible') {
          requestWakeLock();
        }
      };

      document.addEventListener('visibilitychange', handleVisibilityChange);

      // Release wake lock when page is unloaded or refreshed
      window.addEventListener('beforeunload', releaseWakeLock);
    </script>
  </body>
</html>
