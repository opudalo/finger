<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Permissions-Policy" content="screen-wake-lock=()" />
    <title>Finger Training Timer</title>
    <style>
      :root {
        --vh: 1vh; /* Fallback for browsers that don't support dvh */
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: monospace;
        background: #000;
        color: #fff;
        min-height: 100vh;
        min-height: calc(
          var(--vh, 1vh) * 100
        ); /* Fallback for older browsers */
        min-height: 100dvh; /* Dynamic viewport height for mobile */
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        height: calc(var(--vh, 1vh) * 100); /* Fallback for older browsers */
        height: 100dvh; /* Dynamic viewport height for mobile */
        width: 100vw;
        width: 100dvw; /* Dynamic viewport width for mobile */
        padding: 0;
        margin: 0;
      }

      .container {
        text-align: center;
        background: #000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        height: 100vh;
        height: calc(var(--vh, 1vh) * 100); /* Fallback for older browsers */
        height: 100dvh; /* Dynamic viewport height for mobile */
        border: 4px solid #ffff00;
        padding: 20px;
      }

      .exercise-info {
        padding: 20px 0;
        margin-bottom: 30px;
        font-size: min(10vh, 10vw);
      }

      .exercise-name {
        color: #ffff00;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .exercise-details {
        color: #fff;
      }

      .timer-display {
        text-align: center;
        margin: 40px 0;
      }

      .timer-value {
        font-size: min(30vh, 60vw);
        color: #ffff00;
        font-variant-numeric: tabular-nums;
        line-height: 1;
        font-family: monospace;
      }

      button {
        padding: 32px 30px;
        font-size: min(10vh, 15vw);
        width: 100%;
        flex: 1;
        border: 1px solid #ffff00;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 2px;
        background: #000;
        color: #ffff00;
        font-family: monospace;
      }

      button:hover {
        background: #ffff00;
        color: #000;
      }

      .btn-primary {
        background: #ffff00;
        color: #000;
      }

      .btn-primary:hover {
        background: #fff;
      }

      .controls {
        display: flex;
        justify-content: stretch;
        gap: 10px;
        width: 100%;
        margin-top: 30px;
      }

      /* Fullscreen styles */
      :fullscreen {
        background: #000;
      }

      :-webkit-full-screen {
        background: #000;
      }

      :-moz-full-screen {
        background: #000;
      }

      :-ms-fullscreen {
        background: #000;
      }

      /* Ensure the container takes full space in fullscreen */
      :fullscreen .container,
      :-webkit-full-screen .container,
      :-moz-full-screen .container,
      :-ms-fullscreen .container {
        height: 100vh;
        height: calc(var(--vh, 1vh) * 100); /* Fallback for older browsers */
        height: 100dvh; /* Dynamic viewport height for mobile */
        width: 100vw;
        width: 100dvw; /* Dynamic viewport width for mobile */
        border: none;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="exercise-info">
        <div class="exercise-name" id="exerciseName">READY 1.1</div>
        <div class="exercise-details" id="exerciseDetails">&nbsp;</div>
      </div>

      <div class="timer-display">
        <div class="timer-value" id="timerValue">0</div>
      </div>

      <div class="controls">
        <button class="btn-primary" id="startBtn" onclick="startTimer()">
          START
        </button>
        <button id="pauseBtn" onclick="pauseTimer()" style="display: none">
          PAUSE
        </button>
      </div>
    </div>

    <script>
      const exercises = [
        { name: 'Half Crimp', sets: 6, workTime: 10, restTime: 15 },
        { name: '3 Finger Drag', sets: 6, workTime: 10, restTime: 15 },
        { name: 'Front 2 Finger Drag', sets: 2, workTime: 10, restTime: 15 },
        { name: 'Middle 2 Finger Drag', sets: 2, workTime: 10, restTime: 15 },
        {
          name: 'Front 2 Finger Half Crimp',
          sets: 2,
          workTime: 10,
          restTime: 15
        },
        {
          name: 'Middle 2 Finger Half Crimp',
          sets: 2,
          workTime: 10,
          restTime: 15
        }
      ];

      let currentExerciseIndex = 0;
      let currentSet = 0;
      let currentTime = 0;
      let isWorking = true;
      let isPaused = false;
      let timerInterval = null;
      let wakeLock = null;
      let keepAliveInterval = null;
      let videoElement = null;
      let noSleepInterval = null;

      const audioContext = new (window.AudioContext ||
        window.webkitAudioContext)();

      async function requestWakeLock() {
        console.log('Requesting wake lock...');

        // Strategy 1: Modern Wake Lock API
        try {
          if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('Wake lock acquired');
          }
        } catch (err) {
          console.log('Wake lock failed:', err);
        }

        // Strategy 2: Hidden video element (most reliable for iPhone)
        if (!videoElement) {
          videoElement = document.createElement('video');
          videoElement.setAttribute('muted', '');
          videoElement.setAttribute('playsinline', '');
          videoElement.setAttribute('webkit-playsinline', '');
          videoElement.style.position = 'absolute';
          videoElement.style.top = '-1px';
          videoElement.style.left = '-1px';
          videoElement.style.width = '1px';
          videoElement.style.height = '1px';
          videoElement.style.opacity = '0';
          videoElement.style.pointerEvents = 'none';

          // Create a minimal video data URL (1x1 pixel, 1 second duration)
          const canvas = document.createElement('canvas');
          canvas.width = 1;
          canvas.height = 1;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = 'black';
          ctx.fillRect(0, 0, 1, 1);

          // Convert to video blob
          const stream = canvas.captureStream(1);
          videoElement.srcObject = stream;
          videoElement.loop = true;
          videoElement.muted = true;
          videoElement.volume = 0;
          videoElement.setAttribute('autoplay', '');
          videoElement.play().catch(e => console.log('Video play failed:', e));

          document.body.appendChild(videoElement);
          console.log('Video element created for wake lock');
        }

        // Strategy 3: Audio context keep-alive
        if (!keepAliveInterval) {
          keepAliveInterval = setInterval(() => {
            if (audioContext.state === 'running') {
              // Create a very short, silent audio to keep context alive
              const buffer = audioContext.createBuffer(1, 1, 22050);
              const source = audioContext.createBufferSource();
              source.buffer = buffer;
              source.connect(audioContext.destination);
              source.start();
            }
          }, 5000); // Every 5 seconds
        }

        // Strategy 4: Aggressive no-sleep interval
        if (!noSleepInterval) {
          noSleepInterval = setInterval(() => {
            // Multiple strategies to prevent sleep
            if (videoElement && videoElement.paused) {
              videoElement
                .play()
                .catch(e => console.log('Video resume failed:', e));
            }

            // Trigger a small user interaction simulation
            const event = new Event('touchstart', { bubbles: true });
            document.body.dispatchEvent(event);

            // Keep audio context active
            if (audioContext.state === 'suspended') {
              audioContext
                .resume()
                .catch(e => console.log('Audio resume failed:', e));
            }
          }, 3000); // Every 3 seconds
        }
      }

      function releaseWakeLock() {
        console.log('Releasing wake lock...');

        if (wakeLock) {
          wakeLock.release();
          wakeLock = null;
          console.log('Wake lock released');
        }

        if (keepAliveInterval) {
          clearInterval(keepAliveInterval);
          keepAliveInterval = null;
        }

        if (noSleepInterval) {
          clearInterval(noSleepInterval);
          noSleepInterval = null;
        }

        if (videoElement) {
          videoElement.pause();
          videoElement.srcObject = null;
          if (videoElement.parentNode) {
            videoElement.parentNode.removeChild(videoElement);
          }
          videoElement = null;
          console.log('Video element removed');
        }
      }

      function playBeep(frequency = 1200, duration = 0.3) {
        try {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.frequency.value = frequency;
          oscillator.type = 'sine';

          gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            audioContext.currentTime + duration
          );

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + duration);
        } catch (e) {
          console.log('Audio playback failed:', e);
        }
      }

      function updateDisplay() {
        const exercise = exercises[currentExerciseIndex];
        const totalTime = isWorking ? exercise.workTime : exercise.restTime;
        const timeLeft = totalTime - currentTime;

        document.getElementById('timerValue').textContent = timeLeft;

        if (isWorking) {
          document.getElementById('exerciseName').textContent =
            exercise.name.toUpperCase();
          document.getElementById('exerciseDetails').textContent = `Set ${
            currentSet + 1
          } of ${exercise.sets}`;
        } else {
          document.getElementById('exerciseName').textContent = 'REST';
          document.getElementById('exerciseDetails').textContent = `${
            currentSet < exercise.sets - 1
              ? exercise.name
              : currentExerciseIndex < exercises.length - 1
              ? exercises[currentExerciseIndex + 1].name
              : 'Complete!'
          }`;
        }
      }

      function tick() {
        if (isPaused) return;

        const exercise = exercises[currentExerciseIndex];
        const totalTime = isWorking ? exercise.workTime : exercise.restTime;

        currentTime++;

        if (currentTime >= totalTime) {
          playBeep(1200, 0.3);

          currentTime = 0;

          if (isWorking) {
            isWorking = false;

            if (currentSet >= exercise.sets - 1) {
              currentSet = 0;
              currentExerciseIndex++;

              if (currentExerciseIndex >= exercises.length) {
                completeTraining();
                return;
              }
            } else {
              currentSet++;
            }
          } else {
            isWorking = true;
          }
        }

        updateDisplay();
      }

      async function startTimer() {
        if (timerInterval) return;

        isPaused = false;
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('pauseBtn').style.display = 'inline-block';

        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }

        // Request fullscreen
        try {
          if (document.documentElement.requestFullscreen) {
            await document.documentElement.requestFullscreen();
          } else if (document.documentElement.webkitRequestFullscreen) {
            await document.documentElement.webkitRequestFullscreen();
          } else if (document.documentElement.msRequestFullscreen) {
            await document.documentElement.msRequestFullscreen();
          }
        } catch (err) {
          console.log('Fullscreen request failed:', err);
        }

        // Start 5-second countdown
        let countdown = 5;
        document.getElementById('exerciseName').textContent = 'GET READY';
        document.getElementById('exerciseDetails').textContent =
          'Starting in...';
        document.getElementById('timerValue').textContent = countdown;

        const countdownInterval = setInterval(() => {
          countdown--;
          document.getElementById('timerValue').textContent = countdown;

          if (countdown <= 0) {
            clearInterval(countdownInterval);
            // Start the actual timer
            updateDisplay();
            timerInterval = setInterval(tick, 1000);
            // Request wake lock to prevent phone from sleeping
            requestWakeLock();
          }
        }, 1000);
      }

      function pauseTimer() {
        isPaused = !isPaused;
        document.getElementById('pauseBtn').textContent = isPaused
          ? 'RESUME'
          : 'PAUSE';
      }

      function completeTraining() {
        clearInterval(timerInterval);
        timerInterval = null;

        // Release wake lock when training is complete
        releaseWakeLock();

        // Exit fullscreen
        try {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        } catch (err) {
          console.log('Exit fullscreen failed:', err);
        }

        document.getElementById('exerciseName').textContent = 'COMPLETE!';
        document.getElementById('exerciseDetails').textContent =
          'Great job! All exercises finished.';
        document.getElementById('timerValue').textContent = 'âœ“';

        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('pauseBtn').style.display = 'none';

        playBeep(1000, 0.2);
        setTimeout(() => playBeep(1200, 0.2), 200);
        setTimeout(() => playBeep(1500, 0.3), 400);
      }

      // Mobile viewport height fix for older browsers
      function setMobileViewportHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      }

      // Set viewport height on load and resize
      setMobileViewportHeight();
      window.addEventListener('resize', setMobileViewportHeight);
      window.addEventListener('orientationchange', () => {
        setTimeout(setMobileViewportHeight, 100);
      });

      // Release wake lock when page is unloaded or refreshed
      window.addEventListener('beforeunload', releaseWakeLock);
      window.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          releaseWakeLock();
        }
      });
    </script>
  </body>
</html>
